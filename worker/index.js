// worker/index.js
const { Queue, Worker } = require('bullmq');
const IORedis = require('ioredis');
const OpenAI = require('openai');
const axios = require('axios');

// OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ë‰´ìŠ¤ API ì„¤ì •
const NEWS_API_KEY = process.env.NEWS_API_KEY || 'your-news-api-key';
const NEWS_API_URL = 'https://newsapi.org/v2/everything';

// ë‹¤ì–‘í•œ ì‚¬ìš©ì ë‹‰ë„¤ì„ ëª©ë¡
const diverseAuthors = [
  'ë¬´ì£¼íƒì²­ë…„', 'ì „ì„¸ê³ ë¯¼ëŸ¬', 'ì›”ì„¸ì ˆì•½ì™•', 'ë¶€ë™ì‚°ì´ˆë³´', 'ì›ë£¸íƒì •',
  'ê³„ì•½ì„œë‹¬ì¸', 'ë³´ì¦ê¸ˆì „ë¬¸ê°€', 'ì„ëŒ€ì°¨ê³ ìˆ˜', 'ë¶€ë™ì‚°ì •ë³´í†µ', 'ì£¼ê±°ê³ ë¯¼ìƒë‹´ì‚¬',
  'ì „ì„¸ë§ˆìŠ¤í„°', 'ì›”ì„¸í˜‘ìƒê°€', 'ì›ë£¸í—Œí„°', 'ê³„ì•½ê³ ìˆ˜', 'ë³´ì¦ê¸ˆì™•',
  'ì„ëŒ€ì°¨ë°•ì‚¬', 'ë¶€ë™ì‚°ë§¤ë‹ˆì•„', 'ì£¼ê±°ì „ë¬¸ê°€', 'ì „ì„¸ê³ ìˆ˜', 'ì›”ì„¸ë‹¬ì¸',
  'ì›ë£¸ë§ˆìŠ¤í„°', 'ê³„ì•½ì„œê³ ìˆ˜', 'ë³´ì¦ê¸ˆì „ë¬¸', 'ì„ëŒ€ì°¨ì™•', 'ë¶€ë™ì‚°ê³ ìˆ˜',
  'ì£¼ê±°ì •ë³´í†µ', 'ì „ì„¸ì „ë¬¸ê°€', 'ì›”ì„¸ê³ ìˆ˜', 'ì›ë£¸ì „ë¬¸', 'ê³„ì•½ë‹¬ì¸',
  'ë³´ì¦ê¸ˆê³ ìˆ˜', 'ì„ëŒ€ì°¨ì „ë¬¸', 'ë¶€ë™ì‚°ë‹¬ì¸', 'ì£¼ê±°ê³ ìˆ˜', 'ì „ì„¸ì™•',
  'ì›”ì„¸ì „ë¬¸ê°€', 'ì›ë£¸ê³ ìˆ˜', 'ê³„ì•½ì „ë¬¸ê°€', 'ë³´ì¦ê¸ˆë‹¬ì¸', 'ì„ëŒ€ì°¨ê³ ìˆ˜'
];

// OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// Node.js 18+ ì—ì„œ fetch ì‚¬ìš© ê°€ëŠ¥, ê·¸ ì´í•˜ ë²„ì „ì—ì„œëŠ” node-fetch í•„ìš”
// const fetch = require('node-fetch');

// Redis ì—°ê²° (ì„ íƒì )
let connection = null;
let postQueue = null;
const queueName = 'postQueue';

// Redis ì—°ê²° ì™„ì „ ë¹„í™œì„±í™” (ë©”ëª¨ë¦¬ ëª¨ë“œë¡œ ì‹¤í–‰)
console.log('âš ï¸ Redis ì—°ê²° ë¹„í™œì„±í™”, ë©”ëª¨ë¦¬ ëª¨ë“œë¡œ ì‹¤í–‰');

// ì‹¤ì œ ì‘ì—…ì ë¡œì§ (Redisê°€ ìˆì„ ë•Œë§Œ)
if (connection && postQueue) {
  new Worker(
    queueName,
    async (job) => {
      const { title, content, categorySlug } = job.data;

      console.log(`ğŸ“¢ ê²Œì‹œê¸€ ìƒì„± ì¤‘: ${title}`);

      const res = await fetch(`${process.env.SITE_BASE_URL}/api/admin/posts`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${process.env.ADMIN_TOKEN}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          title,
          content,
          categorySlug,
          status: 'published',
          tags: ['ìë™ì‘ì„±'],
        }),
      });

      if (!res.ok) {
        const text = await res.text();
        throw new Error(`âŒ POST ì‹¤íŒ¨: ${res.status} ${text}`);
      }

      await new Promise((r) => setTimeout(r, 1000)); // ê²Œì‹œ ê°„ê²© (1ì´ˆ)
    },
    { connection, concurrency: 1 }
  );
}

// ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” íƒœê·¸ë“¤ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
function getTagsForCategory(category) {
  const tagMap = {
    'ì‹œí™©': ['ì‹œí™©', 'ë¶€ë™ì‚°ì‹œì¥'],
    'ììœ ': ['ììœ ', 'ì¼ìƒ'],
    'ë¶€ë™ì‚°ì‹œì¥': ['ë¶€ë™ì‚°ì‹œì¥', 'ë¶€ë™ì‚°'],
    'ì„ëŒ€ì‹œì¥': ['ì„ëŒ€ì‹œì¥', 'ì›”ì„¸ì¸ìƒ'],
    'ë¶„ìŸì‚¬ë¡€': ['ë¶„ìŸì‚¬ë¡€', 'ë²•ì ê¶Œë¦¬'],
    'ë³´ì¦ê¸ˆ': ['ë³´ì¦ê¸ˆ', 'ê³„ì•½í•´ì§€'],
    'ì›”ì„¸ì¸ìƒ': ['ì›”ì„¸ì¸ìƒ', 'ì§‘ì£¼ì¸ì†Œí†µ'],
    'ê³„ì•½í•´ì§€': ['ê³„ì•½í•´ì§€', 'ì•ˆì „ìˆ˜ì¹™'],
    'ì…ì£¼ì²´í¬': ['ì…ì£¼ì²´í¬', 'ì•ˆì „ìˆ˜ì¹™'],
    'ì§‘ì£¼ì¸ì†Œí†µ': ['ì§‘ì£¼ì¸ì†Œí†µ', 'ë²•ì ê¶Œë¦¬'],
    'íˆ¬ì': ['íˆ¬ì', 'ì •ì±…'],
    'ì •ì±…': ['ì •ì±…', 'ë²•ì ê¶Œë¦¬']
  };
  
  return tagMap[category] || [category];
}

// ìµœì‹  ë¶€ë™ì‚° ë‰´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (êµ¬ì²´ì ì¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰)
async function fetchRealEstateNews() {
  try {
    const response = await axios.get(NEWS_API_URL, {
      params: {
        q: 'ë¶€ë™ì‚° OR ì•„íŒŒíŠ¸ OR ì „ì„¸ OR ë¹Œë¼ OR ì›”ì„¸ OR "ë¶€ë™ì‚° ì •ì±…" OR "ì „ì„¸ ëŒ€ì¶œ" OR "ì›”ì„¸ ìƒí•œì œ" OR "ì„ëŒ€ì°¨ 3ë²•" OR "ì²­ë…„ ì „ì„¸" OR "ì£¼íƒ ê³µê¸‰" OR "ë¶€ë™ì‚° ì‹œì¥" OR "ì „ì„¸ê°€" OR "ì›”ì„¸ê°€" OR "ì„ëŒ€ë£Œ"',
        language: 'ko',
        sortBy: 'publishedAt',
        pageSize: 15,
        apiKey: NEWS_API_KEY
      }
    });
    
    return response.data.articles || [];
  } catch (error) {
    console.log('ë‰´ìŠ¤ API ì˜¤ë¥˜:', error.message);
    return [];
  }
}

// ë‰´ìŠ¤ ê¸°ë°˜ í† ë¡ ê¸€ ìƒì„± (êµ¬ì²´ì ì´ê³  í˜„ì‹¤ì ìœ¼ë¡œ)
async function generateNewsBasedPost(newsItem) {
  try {
    const prompt = `
ë‹¤ìŒ ë¶€ë™ì‚° ë‰´ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¬´ì£¼íƒì´Œ ì»¤ë®¤ë‹ˆí‹° í† ë¡ ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”:

ë‰´ìŠ¤ ì œëª©: ${newsItem.title}
ë‰´ìŠ¤ ë‚´ìš©: ${newsItem.description || newsItem.content || ''}
ë‰´ìŠ¤ ì¶œì²˜: ${newsItem.source?.name || ''}
ë°œí–‰ì¼: ${newsItem.publishedAt || ''}

ìš”êµ¬ì‚¬í•­:
1. ì œëª©ì€ 30ì ì´ë‚´ë¡œ ì‘ì„± (ë‰´ìŠ¤ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•˜ì§€ë§Œ ì§ì ‘ì ì¸ ë‰´ìŠ¤ ì œëª©ì´ ì•„ë‹Œ í† ë¡  ì£¼ì œë¡œ)
2. ë‚´ìš©ì€ 300-500ì ì •ë„ë¡œ ì‘ì„±
3. ì‹¤ì œ ë¬´ì£¼íƒì/ì „ì„¸ì/ì›”ì„¸ìì˜ ê´€ì ì—ì„œ ì‘ì„±
4. ë‰´ìŠ¤ì˜ êµ¬ì²´ì ì¸ ë‚´ìš©(ìˆ˜ì¹˜, ì§€ì—­, ì •ì±…ëª… ë“±)ì„ í¬í•¨
5. ë‰´ìŠ¤ê°€ ê°œì¸ì—ê²Œ ë¯¸ì¹˜ëŠ” ì‹¤ì œì ì¸ ì˜í–¥ì— ëŒ€í•´ ì–¸ê¸‰
6. ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì´ ëŒ“ê¸€ì„ ë‹¬ê³  ì‹¶ì–´í•  ë§Œí•œ êµ¬ì²´ì ì¸ ì§ˆë¬¸ì´ë‚˜ ì˜ê²¬ ìš”ì²­ í¬í•¨
7. ì¹œê·¼í•˜ì§€ë§Œ í˜„ì‹¤ì ì¸ í†¤ìœ¼ë¡œ ì‘ì„±
8. í•œêµ­ì–´ë¡œ ì‘ì„±
9. ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
10. "ì–´ë–»ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”?" ê°™ì€ ì¼ë°˜ì ì¸ ì§ˆë¬¸ë³´ë‹¤ëŠ” êµ¬ì²´ì ì¸ ìƒí™©ì— ëŒ€í•œ ì˜ê²¬ì„ ìš”ì²­

ì‘ë‹µ í˜•ì‹:
ì œëª©: [ì œëª©]
ë‚´ìš©: [ë‚´ìš©]
íƒœê·¸: [íƒœê·¸1,íƒœê·¸2]
`;

    const completion = await openai.chat.completions.create({
      model: "gpt-3.5-turbo",
      messages: [{ role: "user", content: prompt }],
      max_tokens: 800,
      temperature: 0.7,
    });

    const response = completion.choices[0]?.message?.content || '';
    
    // ì‘ë‹µ íŒŒì‹±
    const titleMatch = response.match(/ì œëª©:\s*(.+)/);
    const contentMatch = response.match(/ë‚´ìš©:\s*([\s\S]+?)(?=íƒœê·¸:|$)/);
    const tagsMatch = response.match(/íƒœê·¸:\s*(.+)/);
    
    const title = titleMatch?.[1]?.trim() || newsItem.title;
    const content = contentMatch?.[1]?.trim() || '';
    const tags = tagsMatch?.[1]?.split(',').map(t => t.trim()) || ['ì‹œí™©'];

    return { title, content, tags };
  } catch (error) {
    console.log('OpenAI ë‰´ìŠ¤ ê¸°ë°˜ ê¸€ ìƒì„± ì˜¤ë¥˜:', error.message);
    return {
      title: `${newsItem.title}ì— ëŒ€í•´ ì–´ë–»ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”?`,
      content: `${newsItem.title} ë‰´ìŠ¤ë¥¼ ë³´ë‹ˆ ì •ë§ ê±±ì •ì´ ë˜ë„¤ìš”. ì—¬ëŸ¬ë¶„ì€ ì–´ë–»ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”? ì‹¤ì œ ê²½í—˜ë‹´ì´ë‚˜ ì˜ê²¬ì´ ìˆìœ¼ì‹œë©´ ëŒ“ê¸€ë¡œ ê³µìœ í•´ì£¼ì„¸ìš”!`,
      tags: ['ì‹œí™©']
    };
  }
}

// AI ê¸°ë°˜ êµ¬ì²´ì ì´ê³  í˜„ì‹¤ì ì¸ ëŒ“ê¸€ ìƒì„±
async function generateAIComment(postContent, postTitle, commentCount = 3) {
  try {
    const prompt = `
ë‹¤ìŒ í† ë¡ ê¸€ì— ëŒ€í•œ êµ¬ì²´ì ì´ê³  í˜„ì‹¤ì ì¸ ëŒ“ê¸€ ${commentCount}ê°œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

ì œëª©: ${postTitle}
ë‚´ìš©: ${postContent}

ìš”êµ¬ì‚¬í•­:
1. ê° ëŒ“ê¸€ì€ 30-100ì ì •ë„ë¡œ ì‘ì„±
2. ì‹¤ì œ ë¬´ì£¼íƒì/ì „ì„¸ì/ì›”ì„¸ìì˜ ê´€ì ì—ì„œ ì‘ì„±
3. êµ¬ì²´ì ì¸ ìˆ˜ì¹˜, ì§€ì—­, ê²½í—˜ë‹´ì„ í¬í•¨
4. ë‰´ìŠ¤ë‚˜ ì •ì±…ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì˜ê²¬ ì œì‹œ
5. ì‹¤ì œ ìƒí™©ì— ëŒ€í•œ í˜„ì‹¤ì ì¸ ì¡°ì–¸ì´ë‚˜ ê²½í—˜ ê³µìœ 
6. ì¹œê·¼í•˜ì§€ë§Œ ì „ë¬¸ì ì¸ í†¤ìœ¼ë¡œ ì‘ì„±
7. í•œêµ­ì–´ë¡œ ì‘ì„±
8. ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
9. ê° ëŒ“ê¸€ì€ ì„œë¡œ ë‹¤ë¥¸ ê´€ì ì´ë‚˜ êµ¬ì²´ì ì¸ ê²½í—˜ì„ ë°˜ì˜
10. "ê³µê°í•©ë‹ˆë‹¤", "ì¢‹ì€ ê¸€ì…ë‹ˆë‹¤" ê°™ì€ ì¼ë°˜ì ì¸ ëŒ“ê¸€ ê¸ˆì§€
11. êµ¬ì²´ì ì¸ ì§€ì—­ëª…, ê¸ˆì•¡, ì •ì±…ëª… ë“±ì„ ì–¸ê¸‰

ì‘ë‹µ í˜•ì‹:
ëŒ“ê¸€1: [êµ¬ì²´ì ì¸ ë‚´ìš©]
ëŒ“ê¸€2: [êµ¬ì²´ì ì¸ ë‚´ìš©]
ëŒ“ê¸€3: [êµ¬ì²´ì ì¸ ë‚´ìš©]
`;

    const completion = await openai.chat.completions.create({
      model: "gpt-3.5-turbo",
      messages: [{ role: "user", content: prompt }],
      max_tokens: 600,
      temperature: 0.8,
    });

    const response = completion.choices[0]?.message?.content || '';
    
    // ëŒ“ê¸€ íŒŒì‹±
    const comments = [];
    for (let i = 1; i <= commentCount; i++) {
      const commentMatch = response.match(new RegExp(`ëŒ“ê¸€${i}:\\s*(.+?)(?=ëŒ“ê¸€${i+1}:|$)`));
      if (commentMatch) {
        comments.push(commentMatch[1].trim());
      }
    }
    
    return comments.filter(comment => comment.length > 0);
  } catch (error) {
    console.log('AI ëŒ“ê¸€ ìƒì„± ì˜¤ë¥˜:', error.message);
    return [
      'ì„œìš¸ ê°•ë‚¨êµ¬ì—ì„œ ì „ì„¸ êµ¬í•˜ëŠ”ë° ì •ë§ ì–´ë ¤ì›Œìš”',
      'ì›”ì„¸ 50ë§Œì›ì¸ë° ì˜¬í•´ 10% ì˜¬ëì–´ìš”',
      'ì²­ë…„ ì „ì„¸ëŒ€ì¶œ ì‹ ì²­í–ˆëŠ”ë° ìŠ¹ì¸ê¹Œì§€ 2ì£¼ ê±¸ë ¸ìŠµë‹ˆë‹¤'
    ];
  }
}

// í† ë¡  ì£¼ì œ í…œí”Œë¦¿ (12ê°œ ì¹´í…Œê³ ë¦¬ë¡œ í™•ì¥)
const discussionTemplates = {
  ì‹œí™©: [
    'ìš”ì¦˜ ë¶€ë™ì‚° ì‹œì¥ ì–´ë–»ê²Œ ë³´ì‹œë‚˜ìš”?',
    'ì „ì„¸ ì‹œì¥ ë™í–¥ ë¶„ì„',
    'ì›”ì„¸ ìƒìŠ¹ì„¸ ê³„ì†ë ê¹Œìš”?',
    'ë¶€ë™ì‚° ì •ì±… ë³€í™” ì „ë§',
    'ì§€ì—­ë³„ ì„ëŒ€ì‹œì¥ í˜„í™©',
    'ë¶€ë™ì‚° ì‹œì¥ ê°œë¯¸ì¹˜ë„¤ ì§„ì§œ',
    'ì›”ì„¸ ì˜¬ë¼ê°€ëŠ” ì†ë„ ë¯¸ì³¤ìŒ',
    'ì „ì„¸ ì‹œì¥ ì–¸ì œ ì•ˆì •ë ê¹Œ?',
    'ë¶€ë™ì‚° ì •ì±… ìê¾¸ ë°”ë€Œì–´ì„œ í˜¼ë€ìŠ¤ëŸ¬ì›Œ',
    'ì§€ê¸ˆì´ ê³„ì•½í•˜ê¸° ì¢‹ì€ íƒ€ì´ë°ì¼ê¹Œ?'
  ],
  ììœ : [
    'ë¬´ì£¼íƒì´Œì—ì„œ ì‚´ì•„ê°€ëŠ” íŒ ê³µìœ í•´ìš”',
    'ì „ì„¸ vs ì›”ì„¸ ê³ ë¯¼ì…ë‹ˆë‹¤',
    'ì›ë£¸ êµ¬í•˜ê¸° ì–´ë ¤ìš´ ì‹œê¸°ì¸ê°€ìš”?',
    'ì§‘ êµ¬í•  ë•Œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒ',
    'ë¬´ì£¼íƒ ê¸°ê°„ì´ ê¸¸ì–´ì§€ë©´ì„œ ëŠë¼ëŠ” ì ë“¤',
    'ì›ë£¸ êµ¬í•˜ê¸° ê°œë¹¡ì„¸ë„¤ ã… ã… ',
    'ì „ì„¸ ì›”ì„¸ ê³ ë¯¼ë˜ë„¤ ì§„ì§œ',
    'ì§‘ êµ¬í•˜ê¸° ë„ˆë¬´ ì–´ë ¤ì›Œì„œ ë¯¸ì¹˜ê² ìŒ',
    'ë¬´ì£¼íƒ ìƒí™œ 2ë…„ì°¨ì¸ë° ì§€ì³',
    'ì›ë£¸ ì°¾ìœ¼ëŸ¬ ë‹¤ë‹ˆëŠ”ê²Œ ì§€ì˜¥ì´ì•¼'
  ],
  ë¶€ë™ì‚°ì‹œì¥: [
    'ì•„íŒŒíŠ¸ vs ì˜¤í”¼ìŠ¤í…” ê³ ë¯¼',
    'ì‹ ì¶• vs ë¦¬ëª¨ë¸ë§ ì–´ëŠê²Œ ë‚˜ì„ê¹Œ?',
    'ë¶€ë™ì‚° ì¤‘ê°œë¹„ ì ˆì•½ ë°©ë²•',
    'ë§¤ë¬¼ ì •ë³´ ì–´ë””ì„œ êµ¬í•˜ì‹œë‚˜ìš”?',
    'ë¶€ë™ì‚° ê³„ì•½ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸',
    'ì•„íŒŒíŠ¸ ì˜¤í”¼ìŠ¤í…” ë­ê°€ ë‚˜ì„ê¹Œ?',
    'ì¤‘ê°œë¹„ ë„ˆë¬´ ë¹„ì‹¸ì„œ ë¯¸ì¹˜ê² ì–´',
    'ì‹ ì¶•ì´ë‘ ë¦¬ëª¨ë¸ë§ ì¤‘ì— ë­ê°€ ì¢‹ìŒ?',
    'ë¶€ë™ì‚° ë§¤ë¬¼ ì–´ë””ì„œ ì°¾ì•„?',
    'ê³„ì•½í•  ë•Œ ë­˜ ì²´í¬í•´ì•¼ í•¨?'
  ],
  ì„ëŒ€ì‹œì¥: [
    'ì›”ì„¸ í˜‘ìƒ ì„±ê³µ ê²½í—˜ë‹´',
    'ë³´ì¦ê¸ˆ ë°˜í™˜ ê´€ë ¨ ê²½í—˜',
    'ì„ëŒ€ì°¨ ê³„ì•½ì„œ ê¼¼ê¼¼íˆ ì±™ê¸°ê¸°',
    'ì›”ì„¸ ì¸ìƒ ì œí•œ ì¡°í•­',
    'ì„ëŒ€ì¸ê³¼ì˜ ì†Œí†µ íŒ',
    'ì›”ì„¸ í˜‘ìƒ ì–´ë–»ê²Œ í•´ì•¼ í•¨?',
    'ë³´ì¦ê¸ˆ ëŒë ¤ë°›ê¸° ê°œì–´ë ¤ì›€',
    'ê³„ì•½ì„œ ì½ê¸° ë„ˆë¬´ ë³µì¡í•´',
    'ì§‘ì£¼ì¸ì´ ì›”ì„¸ ì˜¬ë¦°ë‹¤ê³  í•˜ëŠ”ë° ë§‰ì„ ìˆ˜ ìˆìŒ?',
    'ì§‘ì£¼ì¸ì´ë‘ ì–´ë–»ê²Œ ëŒ€í™”í•´ì•¼ í•¨?'
  ],
  ë¶„ìŸì‚¬ë¡€: [
    'ë³´ì¦ê¸ˆ ë°˜í™˜ ê±°ë¶€ ë‹¹í–ˆì„ ë•Œ',
    'ì›”ì„¸ ì¸ìƒ í†µë³´ ë°›ì•˜ì„ ë•Œ',
    'ì‹œì„¤ ê³ ì¥ ì‹œ ì²˜ë¦¬ ë°©ë²•',
    'ì…ì£¼ ê±°ë¶€ ë‹¹í•œ ê²½í—˜',
    'ê³„ì•½ í•´ì§€ ê´€ë ¨ ë¶„ìŸ',
    'ë³´ì¦ê¸ˆ ì•ˆ ëŒë ¤ì¤€ë‹¤ê³  ê°œë¹¡ì³',
    'ì›”ì„¸ ì˜¬ë¦°ë‹¤ê³  ê°‘ìê¸° í†µë³´í•¨',
    'ì—ì–´ì»¨ ê³ ì¥ë‚¬ëŠ”ë° ëˆ„ê°€ ê³ ì³?',
    'ê³„ì•½í–ˆëŠ”ë° ì…ì£¼ ê±°ë¶€ë‹¹í•¨',
    'ì§‘ì£¼ì¸í•˜ê³  ì‹¸ì› ëŠ”ë° ì–´ë–»ê²Œ í•´ê²°í•¨?'
  ],
  ë³´ì¦ê¸ˆ: [
    'ë³´ì¦ê¸ˆ ë°˜í™˜ ë°›ëŠ” íŒ',
    'ë³´ì¦ê¸ˆ ëŒ€ì¶œ ì´ìš©í•´ë³´ì‹  ë¶„?',
    'ë³´ì¦ê¸ˆ ì ë¦½ê¸ˆ í™œìš©ë²•',
    'ë³´ì¦ê¸ˆ ë°˜í™˜ ì‹œê¸°',
    'ë³´ì¦ê¸ˆ ê´€ë ¨ ë²•ì  ê¶Œë¦¬',
    'ë³´ì¦ê¸ˆ ëŒë ¤ë°›ê¸° ê°œí˜ë“¤ì–´',
    'ë³´ì¦ê¸ˆ ëŒ€ì¶œ ì¨ë³¸ ì‚¬ëŒ ìˆìŒ?',
    'ë³´ì¦ê¸ˆ ì–´ë–»ê²Œ í™œìš©í•¨?',
    'ë³´ì¦ê¸ˆ ì–¸ì œì¯¤ ëŒë ¤ë°›ì„ ìˆ˜ ìˆìŒ?',
    'ë³´ì¦ê¸ˆ ê´€ë ¨ ë²•ì ìœ¼ë¡œ ë­” ê¶Œë¦¬ ìˆìŒ?'
  ],
  ì›”ì„¸ì¸ìƒ: [
    'ì›”ì„¸ ì¸ìƒë¥  ì–´ëŠ ì •ë„ê°€ ì ì •í•œê°€ìš”?',
    'ì›”ì„¸ í˜‘ìƒ ì„±ê³µ ì‚¬ë¡€',
    'ì›”ì„¸ ì¸ìƒ í†µë³´ ë°›ì•˜ì„ ë•Œ ëŒ€ì²˜ë²•',
    'ì›”ì„¸ ì¸ìƒ ì œí•œ ì¡°í•­ í™œìš©',
    'ì›”ì„¸ vs ì „ì„¸ ì „í™˜ ê³ ë¯¼',
    'ì›”ì„¸ ì¸ìƒë¥  ì–¼ë§ˆë‚˜ ì˜¬ë ¤ë„ ë˜ë‚˜?',
    'ì›”ì„¸ í˜‘ìƒ ì„±ê³µí•œ ì‚¬ëŒ ìˆìŒ?',
    'ì›”ì„¸ ì˜¬ë¦°ë‹¤ê³  ê°‘ìê¸° í†µë³´í•¨ ã…¡ã…¡',
    'ì›”ì„¸ ì¸ìƒ ë§‰ì„ ìˆ˜ ìˆëŠ” ë°©ë²• ìˆìŒ?',
    'ì›”ì„¸ ì „ì„¸ ì „í™˜ ê³ ë¯¼ë˜ë„¤'
  ],
  ê³„ì•½í•´ì§€: [
    'ì„ëŒ€ì°¨ ê³„ì•½ í•´ì§€ ì ˆì°¨',
    'ê³„ì•½ í•´ì§€ ì‹œ ì£¼ì˜ì‚¬í•­',
    'ê°‘ì‘ìŠ¤ëŸ¬ìš´ ê³„ì•½ í•´ì§€ ëŒ€ì²˜ë²•',
    'ê³„ì•½ í•´ì§€ í›„ ì´ì‚¬ ì¤€ë¹„',
    'ê³„ì•½ í•´ì§€ ê´€ë ¨ ë²•ì  ë¬¸ì œ',
    'ê³„ì•½ í•´ì§€ ì ˆì°¨ ê°œë³µì¡í•´',
    'ê³„ì•½ í•´ì§€í•  ë•Œ ë­˜ ì£¼ì˜í•´ì•¼ í•¨?',
    'ê°‘ìê¸° ê³„ì•½ í•´ì§€ ë‹¹í–ˆëŠ”ë° ì–´ì©Œì§€?',
    'ê³„ì•½ í•´ì§€í•˜ê³  ì´ì‚¬ ì¤€ë¹„ ì–´ë–»ê²Œ í•¨?',
    'ê³„ì•½ í•´ì§€ ê´€ë ¨ ë²•ì  ë¬¸ì œ ìƒê²¼ëŠ”ë°'
  ],
  ì…ì£¼ì²´í¬: [
    'ì…ì£¼ ì „ ê¼­ í™•ì¸í•´ì•¼ í•  ì²´í¬ë¦¬ìŠ¤íŠ¸',
    'ì „ì„¸/ì›”ì„¸ ê³„ì•½ ì „ í•„ìˆ˜ í™•ì¸ì‚¬í•­',
    'ë¶€ë™ì‚° ì¤‘ê°œì—…ì†Œ ì„ íƒ ê°€ì´ë“œ',
    'ì„ëŒ€ì°¨ ê³„ì•½ì„œ ê²€í†  í¬ì¸íŠ¸',
    'ì…ì£¼ ì „ ì ê²€í•´ì•¼ í•  ì‹œì„¤ë“¤',
    'ì „ì„¸ê¸ˆ ë°˜í™˜ ë³´ì¥ ë°©ë²•',
    'ì…ì£¼ ì‹œ ì£¼ì˜ì‚¬í•­ê³¼ íŒ',
    'ê³„ì•½ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì•Œë ¤ì£¼ì„¸ìš”',
    'ì…ì£¼í•  ë•Œ ë­˜ í™•ì¸í•´ì•¼ í•¨?',
    'ë¶€ë™ì‚° ì¤‘ê°œì‚¬ ì–´ë–»ê²Œ ì„ íƒí•¨?'
  ],
  ì§‘ì£¼ì¸ì†Œí†µ: [
    'ì§‘ì£¼ì¸ê³¼ì˜ ì›í™œí•œ ì†Œí†µ ë°©ë²•',
    'ì›”ì„¸ í˜‘ìƒ ì‹œ ì§‘ì£¼ì¸ê³¼ì˜ ëŒ€í™”ë²•',
    'ì§‘ì£¼ì¸ê³¼ ê°ˆë“± í•´ê²°í•˜ëŠ” ë°©ë²•',
    'ì§‘ì£¼ì¸ì—ê²Œ ìš”êµ¬ì‚¬í•­ ì „ë‹¬í•˜ëŠ” ë²•',
    'ì§‘ì£¼ì¸ê³¼ì˜ ê´€ê³„ ìœ ì§€ íŒ',
    'ì§‘ì£¼ì¸ê³¼ì˜ ì†Œí†µ ì‹œ ì£¼ì˜ì‚¬í•­',
    'ì§‘ì£¼ì¸ê³¼ ì¹œí•´ì§€ëŠ” ë°©ë²•',
    'ì§‘ì£¼ì¸ì´ë‘ ì–´ë–»ê²Œ ëŒ€í™”í•´ì•¼ í•¨?',
    'ì§‘ì£¼ì¸ê³¼ ê°ˆë“± ìƒê²¼ì„ ë•Œ í•´ê²°ë²•',
    'ì§‘ì£¼ì¸í•œí…Œ ìš”êµ¬ì‚¬í•­ ì–´ë–»ê²Œ ë§í•¨?'
  ],
  íˆ¬ì: [
    'ë¶€ë™ì‚° íˆ¬ì ì„±ê³µ ì „ëµ',
    'ì†Œì•¡ ë¶€ë™ì‚° íˆ¬ì ë°©ë²•',
    'ì „ì„¸ íˆ¬ì ì‹œ ì£¼ì˜ì‚¬í•­',
    'ë¶€ë™ì‚° íˆ¬ì íƒ€ì´ë° ë¶„ì„',
    'íˆ¬ììš© ë¶€ë™ì‚° ì„ íƒ ê¸°ì¤€',
    'ë¶€ë™ì‚° íˆ¬ì ë¦¬ìŠ¤í¬ ê´€ë¦¬',
    'ë¶€ë™ì‚° íˆ¬ì ìˆ˜ìµë¥  ê³„ì‚°ë²•',
    'ë¶€ë™ì‚° íˆ¬ì ì–´ë–»ê²Œ ì‹œì‘í•¨?',
    'ì†Œì•¡ìœ¼ë¡œë„ ë¶€ë™ì‚° íˆ¬ì ê°€ëŠ¥í•¨?',
    'íˆ¬ììš© ë¶€ë™ì‚° ë­ê°€ ì¢‹ìŒ?'
  ],
  ì •ì±…: [
    'ì²­ë…„ ì „ì„¸ëŒ€ì¶œ ì§€ì› ì •ì±… ë³€í™”',
    'ì„ëŒ€ì°¨ 3ë²• ì£¼ìš” ê°œì •ì‚¬í•­',
    'ê³µê³µì„ëŒ€ì£¼íƒ ì‹ ì²­ ì¡°ê±´ê³¼ ì ˆì°¨',
    'ì „ì„¸ìê¸ˆëŒ€ì¶œ ê¸ˆë¦¬ ì¸í•˜ ì†Œì‹',
    'ì„ëŒ€ì‚¬ì—…ì ë“±ë¡ ì˜ë¬´í™”',
    'ì£¼ê±°ê¸‰ì—¬ ì‹ ì²­ ë°©ë²•ê³¼ ì¡°ê±´',
    'ì •ë¶€ ì£¼ê±° ì§€ì› ì •ì±… ì•ˆë‚´',
    'ì²­ë…„ ì „ì„¸ëŒ€ì¶œ ì–´ë–»ê²Œ ì‹ ì²­í•¨?',
    'ê³µê³µì„ëŒ€ì£¼íƒ ì‹ ì²­ ì¡°ê±´ì´ ë­ì„?',
    'ì£¼ê±°ê¸‰ì—¬ ë°›ì„ ìˆ˜ ìˆëŠ” ì¡°ê±´ì´ ë­ì„?'
  ]
};

// ëŒ“ê¸€ í…œí”Œë¦¿
const commentTemplates = [
  'ì¢‹ì€ ì •ë³´ ê°ì‚¬í•©ë‹ˆë‹¤!',
  'ì €ë„ ë¹„ìŠ·í•œ ê²½í—˜ì´ ìˆì–´ìš”',
  'ë„ì›€ì´ ë˜ëŠ” ê¸€ì´ë„¤ìš”',
  'ì¶”ê°€ë¡œ ê¶ê¸ˆí•œ ì ì´ ìˆìŠµë‹ˆë‹¤',
  'ì‹¤ìš©ì ì¸ íŒì´ë„¤ìš”',
  'ì €ë„ ì‹œë„í•´ë³¼ê²Œìš”',
  'ì •ë³´ ê³µìœ  ê°ì‚¬í•©ë‹ˆë‹¤',
  'ìœ ìš©í•œ ë‚´ìš©ì´ë„¤ìš”'
];

// OpenAI APIë¥¼ ì‚¬ìš©í•œ ë‹¤ì–‘í•œ ê²Œì‹œê¸€ ìƒì„±
async function generateRealisticContent(category, title, postType, usePolite) {
  try {
    const prompt = `ë‹¹ì‹ ì€ ë¬´ì£¼íƒ ì„¸ì…ì ì»¤ë®¤ë‹ˆí‹°ì˜ í™œë°œí•œ íšŒì›ì…ë‹ˆë‹¤. 
ì¹´í…Œê³ ë¦¬: ${category}
ì œëª©: ${title}
ê¸€ ìœ í˜•: ${postType}
ë§íˆ¬: ${usePolite ? 'ì¡´ëŒ“ë§' : 'ë°˜ë§'}

ë‹¤ìŒ ê·œì¹™ì„ ë”°ë¼ ê²Œì‹œê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”:
1. ${postType === 'ì§ˆë¬¸' ? 'ê¶ê¸ˆí•œ ì ì„ êµ¬ì²´ì ìœ¼ë¡œ ì§ˆë¬¸' : 'ìœ ìš©í•œ ì •ë³´ë‚˜ ê²½í—˜ì„ êµ¬ì²´ì ìœ¼ë¡œ ê³µìœ '}
2. ${usePolite ? 'ì •ì¤‘í•œ ì¡´ëŒ“ë§ ì‚¬ìš© (ì˜ˆ: ~ì…ë‹ˆë‹¤, ~í•´ìš”, ~ì¸ê°€ìš”?)' : 'ìì—°ìŠ¤ëŸ¬ìš´ DC ìŠ¤íƒ€ì¼ ë°˜ë§ ì‚¬ìš© (ì˜ˆ: ~ì„, ~í•¨, ~ì¸ê°€?)'}
3. ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš© (ğŸ˜Š, ğŸ˜­, ğŸ’¸, ğŸ  ë“±)
4. ì‹¤ì œ ì„¸ì…ìê°€ ì“´ ê²ƒì²˜ëŸ¼ êµ¬ì²´ì ì´ê³  ìƒìƒí•˜ê²Œ
5. HTML íƒœê·¸ ì‚¬ìš© ê¸ˆì§€
6. 3-5ë¬¸ì¥ ì •ë„ì˜ ì ë‹¹í•œ ê¸¸ì´
7. ì¹œê·¼í•˜ê³  ê³µê°ê°€ëŠ” í†¤ìœ¼ë¡œ

ì˜ˆì‹œ (ë°˜ë§):
- ì§ˆë¬¸: "ì›”ì„¸ í˜‘ìƒ ì–´ë–»ê²Œ í•´ì•¼ í•¨? ì§‘ì£¼ì¸í•œí…Œ ë­ë¼ê³  ë§í•´ì•¼ ê¹ì•„ì¤„ê¹Œ? ê²½í—˜ë‹´ ì¢€ ì•Œë ¤ì¤˜ ã… ã… "
- ì •ë³´: "ë³´ì¦ê¸ˆ ëŒë ¤ë°›ì„ ë•Œ ì´ê±° ê¼­ ì²´í¬í•˜ì…ˆ. ë‚˜ëŠ” ì´ê±° ëª°ë¼ì„œ 50ë§Œì› ë‚ ë ¸ìŒ ã…¡ã…¡ ì…ì£¼í•  ë•Œ ì‚¬ì§„ ë‹¤ ì°ì–´ë‘ê³ , í‡´ì‹¤ ë•Œë„ ë˜‘ê°™ì´ ì°ì–´ì„œ ë¹„êµí•´ë¼. íŠ¹íˆ ë²½ì§€, ì¥íŒ, ì‹±í¬ëŒ€ ìƒíƒœ ì œì¼ ì¤‘ìš”í•¨"

ì˜ˆì‹œ (ì¡´ëŒ“ë§):
- ì§ˆë¬¸: "ì›”ì„¸ í˜‘ìƒì€ ì–´ë–»ê²Œ í•˜ë©´ ì¢‹ì„ê¹Œìš”? ì§‘ì£¼ì¸ë¶„ê»˜ ì–´ë–»ê²Œ ë§ì”€ë“œë ¤ì•¼ í• ì§€ ê³ ë¯¼ì´ì—ìš” ã… ã…  ê²½í—˜ë‹´ ê³µìœ  ë¶€íƒë“œë¦½ë‹ˆë‹¤!"
- ì •ë³´: "ë³´ì¦ê¸ˆ ëŒë ¤ë°›ì„ ë•Œ ì´ê²ƒë§Œì€ ê¼­ ì²´í¬í•˜ì„¸ìš”. ì €ëŠ” ëª°ë¼ì„œ 50ë§Œì› ì†í•´ ë´¤ìŠµë‹ˆë‹¤ ğŸ˜­ ì…ì£¼í•  ë•Œ ì‚¬ì§„ì„ ë‹¤ ì°ì–´ë‘ì‹œê³ , í‡´ì‹¤í•  ë•Œë„ ë˜‘ê°™ì´ ì°ì–´ì„œ ë¹„êµí•˜ì„¸ìš”. íŠ¹íˆ ë²½ì§€, ì¥íŒ, ì‹±í¬ëŒ€ ìƒíƒœê°€ ì œì¼ ì¤‘ìš”í•´ìš”!"

ê²Œì‹œê¸€ ë‚´ìš©ë§Œ ì‘ì„±í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª…ì€ í•˜ì§€ ë§ˆì„¸ìš”.`;

    const response = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [
        {
          role: 'system',
          content: 'ë‹¹ì‹ ì€ ë¬´ì£¼íƒ ì„¸ì…ì ì»¤ë®¤ë‹ˆí‹°ì˜ í™œë°œí•œ íšŒì›ì…ë‹ˆë‹¤. DC ìŠ¤íƒ€ì¼ì˜ ë°˜ë§ë¡œ ìì—°ìŠ¤ëŸ½ê³  ê³µê°ê°€ëŠ” ê²Œì‹œê¸€ì„ ì‘ì„±í•©ë‹ˆë‹¤.'
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 0.9,
      max_tokens: 300,
    });

    return response.choices[0].message.content.trim();
  } catch (error) {
    console.error('OpenAI API ì˜¤ë¥˜:', error.message);
    return generateFallbackContent(category, title);
  }
}

// ê²Œì‹œê¸€ì— ëŒ€í•œ ëŒ“ê¸€ ìƒì„± (OpenAI API ì‚¬ìš©)
async function generateComments(postContent, postType, category, commentCount, postUsePolite) {
  try {
    const prompt = `ë‹¹ì‹ ì€ ë¬´ì£¼íƒ ì„¸ì…ì ì»¤ë®¤ë‹ˆí‹°ì˜ ë‹¤ì–‘í•œ íšŒì›ë“¤ì…ë‹ˆë‹¤.
ê²Œì‹œê¸€ ìœ í˜•: ${postType}
ê²Œì‹œê¸€ ë‚´ìš©: ${postContent}
ì¹´í…Œê³ ë¦¬: ${category}

${postType === 'ì§ˆë¬¸' ? 'ì´ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ ëŒ“ê¸€' : 'ì´ ì •ë³´ê¸€ì— ëŒ€í•œ ë°˜ì‘ ëŒ“ê¸€'} ${commentCount}ê°œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.

ê·œì¹™:
1. ê° ëŒ“ê¸€ì€ ì„œë¡œ ë‹¤ë¥¸ ì‚¬ëŒì´ ì‘ì„±í•œ ê²ƒì²˜ëŸ¼ ë‹¤ì–‘í•œ í†¤ ì‚¬ìš©
2. ë°˜ë§ê³¼ ì¡´ëŒ“ë§ì„ ëœë¤í•˜ê²Œ ì„ì–´ì„œ ì‚¬ìš© (ê° ëŒ“ê¸€ë§ˆë‹¤ ë‹¤ë¥¸ ë§íˆ¬)
3. ${postType === 'ì§ˆë¬¸' ? 'êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ë‹µë³€ì´ë‚˜ ê²½í—˜ë‹´' : 'ê³µê°, ì§ˆë¬¸, ì¶”ê°€ ì •ë³´ ì œê³µ ë“± ë‹¤ì–‘í•œ ë°˜ì‘'}
4. ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©
5. ê° ëŒ“ê¸€ì€ 2-4ë¬¸ì¥ ì •ë„
6. ëŒ“ê¸€ë§ˆë‹¤ ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ (êµ¬ë¶„ì: |||)

ì˜ˆì‹œ (ì§ˆë¬¸ê¸€ - ë°˜ë§ê³¼ ì¡´ëŒ“ë§ í˜¼í•©):
ã„¹ã…‡ ë‚˜ë„ ê¶ê¸ˆí–ˆë˜ê±´ë° ã…‹ã…‹ ì§‘ì£¼ì¸í•œí…Œ ì†”ì§í•˜ê²Œ ë§í•˜ë©´ ì˜ì™¸ë¡œ í˜‘ìƒ ì˜ë¨|||ì €ëŠ” ì‘ë…„ì— 5ë§Œì› ê¹ì•˜ì–´ìš” ã…ã… ì‹œì„¸ ì¡°ì‚¬í•´ì„œ ê°€ê²©í‘œ ë³´ì—¬ë“œë¦¬ë©´ì„œ ì–˜ê¸°í–ˆë”ë‹ˆ ë°”ë¡œ OK ë‚˜ì˜¤ë”ë¼êµ¬ìš”|||ì›”ì„¸ëŠ” í˜‘ìƒ ì•ˆë˜ëŠ”ì¤„ ì•Œì•˜ëŠ”ë° ê°€ëŠ¥í•˜êµ¬ë‚˜ ã„·ã„· ë‚˜ë„ í•´ë´ì•¼ì§€|||ì˜¤ ê¿€íŒì´ë„¤ìš”! ì €ì¥í–ˆìŠµë‹ˆë‹¤ ê°ì‚¬í•©ë‹ˆë‹¤ ^^

ì˜ˆì‹œ (ì •ë³´ê¸€ - ë°˜ë§ê³¼ ì¡´ëŒ“ë§ í˜¼í•©):
ì˜¤ ì´ê±° ì§„ì§œ ìœ ìš©í•œ ì •ë³´ë‹¤ ğŸ‘|||ì™„ì „ ê³µê°í•´ìš” ã… ã…  ì €ë„ ì‚¬ì§„ ì•ˆì°ì–´ë†”ì„œ ë³´ì¦ê¸ˆ ê¹ì˜€ê±°ë“ ìš”|||ì´ëŸ° ì •ë³´ ë„ˆë¬´ ê°ì‚¬í•¨ ã…‹ã…‹ ë‹¤ìŒì— ì´ì‚¬ê°ˆ ë•Œ ê¼­ í•´ì•¼ì§€|||ë²½ì§€ í•˜ë‚˜ ì°¢ì–´ì¡Œë‹¤ê³  30ë§Œì› ëœ¯ê²¼ì–´ìš” ã…¡ã…¡ ì •ë§ í™©ë‹¹í–ˆìŠµë‹ˆë‹¤

ëŒ“ê¸€ë“¤ë§Œ ì‘ì„±í•˜ê³ , ë‹¤ë¥¸ ì„¤ëª…ì€ í•˜ì§€ ë§ˆì„¸ìš”.`;

    const response = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [
        {
          role: 'system',
          content: 'ë‹¹ì‹ ì€ ë¬´ì£¼íƒ ì„¸ì…ì ì»¤ë®¤ë‹ˆí‹°ì˜ ë‹¤ì–‘í•œ íšŒì›ë“¤ì…ë‹ˆë‹¤. ê°ì ë‹¤ë¥¸ í†¤ìœ¼ë¡œ ëŒ“ê¸€ì„ ì‘ì„±í•©ë‹ˆë‹¤.'
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      temperature: 1.0, // ë” ë‹¤ì–‘í•œ ëŒ“ê¸€ì„ ìœ„í•´
      max_tokens: 400,
    });

    const commentsText = response.choices[0].message.content.trim();
    return commentsText.split('|||').map(c => c.trim()).filter(c => c.length > 0);
  } catch (error) {
    console.error('ëŒ“ê¸€ ìƒì„± API ì˜¤ë¥˜:', error.message);
    // í´ë°± ëŒ“ê¸€
    return postType === 'ì§ˆë¬¸' 
      ? ['ë‹µë³€ ê°ì‚¬í•©ë‹ˆë‹¤!', 'ì €ë„ ê¶ê¸ˆí–ˆëŠ”ë° ã…‹ã…‹', 'ì˜¤ ì´ê±° ì¢‹ì€ ì •ë³´ë„¤ìš”']
      : ['ê³µê°í•©ë‹ˆë‹¤ ã… ã… ', 'ì €ë„ ë¹„ìŠ·í•œ ê²½í—˜ ìˆì–´ìš”', 'ìœ ìš©í•œ ì •ë³´ ê°ì‚¬í•©ë‹ˆë‹¤!'];
  }
}

// API ì‹¤íŒ¨ ì‹œ í´ë°± í•¨ìˆ˜
function generateFallbackContent(category, title) {
  // ë” ë‹¤ì–‘í•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ í…œí”Œë¦¿ë“¤
  const diverseContents = {
    ììœ : [
      "ìš”ì¦˜ ì •ë§ ë§‰ë§‰í•´ì„œ ê¸€ ì˜¬ë ¤ë´…ë‹ˆë‹¤... ğŸ˜” ì›ë£¸ ì°¾ì€ ì§€ 3ê°œì›”ì§¸ì¸ë° ì •ë§ ì–´ë µë„¤ìš”. ì›”ì„¸ëŠ” ë„ˆë¬´ ë¹„ì‹¸ê³ , ì „ì„¸ëŠ” ë³´ì¦ê¸ˆì´ ë¶€ì¡±í•´ì„œ... í˜¹ì‹œ ë¹„ìŠ·í•œ ìƒí™©ì´ì…¨ë˜ ë¶„ë“¤ ì–´ë–»ê²Œ í•´ê²°í•˜ì…¨ëŠ”ì§€ ì¡°ì–¸ ë¶€íƒë“œë ¤ìš”! ğŸ™",
      "ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì£¼íƒ ìƒí™œí•˜ë©´ì„œ ëŠë¼ëŠ” ì ì´ ë§ì•„ì„œ ê³µìœ í•´ë´…ë‹ˆë‹¤. ì •ë§ ì™¸ë¡œìš¸ ë•Œê°€ ë§ì€ë°, ë¹„ìŠ·í•œ ë§ˆìŒì´ì‹  ë¶„ë“¤ ê³„ì‹ ê°€ìš”? ì„œë¡œ í˜ì´ ë˜ì–´ì£¼ë©´ ì¢‹ê² ì–´ìš” ğŸ’ª",
      "ì „ì„¸ vs ì›”ì„¸ ê³ ë¯¼ì´ ì‹¬í•´ìš”... ğŸ˜… ë¶€ëª¨ë‹˜ì€ ì „ì„¸ë¥¼ ì¶”ì²œí•˜ì‹œëŠ”ë°, ë³´ì¦ê¸ˆì´ ë¶€ë‹´ìŠ¤ëŸ½ê³ ... ì—¬ëŸ¬ë¶„ì€ ì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ ì„ íƒí•˜ì…¨ë‚˜ìš”? ê²½í—˜ë‹´ ë“¤ë ¤ì£¼ì„¸ìš”!",
      "ìš”ì¦˜ ì›ë£¸ êµ¬í•˜ê¸°ê°€ ì •ë§ ì§€ì˜¥ì´ë„¤ìš”... ğŸ˜­ ì¤‘ê°œë¹„ë„ ë¹„ì‹¸ê³ , ì¢‹ì€ ê³³ì€ ê¸ˆë°© ì‚¬ë¼ì§€ê³ ... í˜¹ì‹œ ì¢‹ì€ íŒ ìˆìœ¼ì‹œë©´ ê³µìœ í•´ì£¼ì„¸ìš”!",
      "ë¬´ì£¼íƒ ìƒí™œ 2ë…„ì°¨ì…ë‹ˆë‹¤. ì²˜ìŒì—” ììœ ë¡œì›Œì„œ ì¢‹ì•˜ëŠ”ë° ì´ì œëŠ” ì •ë§ í˜ë“¤ì–´ìš”... ğŸ  ì§‘ì— ëŒ€í•œ ê·¸ë¦¬ì›€ì´ ì»¤ì§€ë„¤ìš”. ì—¬ëŸ¬ë¶„ì€ ì–´ë– ì‹ ê°€ìš”?"
    ],
    ì‹œí™©: [
      "ìš”ì¦˜ ë¶€ë™ì‚° ì‹œì¥ì´ ë„ˆë¬´ ë¶ˆì•ˆì •í•´ì„œ ë°¤ì ì„ ëª» ìê³  ìˆì–´ìš”... ğŸ˜° ì •ë§ ì–¸ì œì¯¤ ì•ˆì •ë ê¹Œìš”? ì „ë¬¸ê°€ë¶„ë“¤ ì˜ê²¬ ê¶ê¸ˆí•©ë‹ˆë‹¤!",
      "ì „ì„¸ ì‹œì¥ì´ ê³„ì† ì˜¤ë¥´ë½ë‚´ë¦¬ë½í•˜ëŠ”ë° ì •ë§ ìŠ¤íŠ¸ë ˆìŠ¤ì˜ˆìš”... ğŸ˜“ ì§€ê¸ˆì´ ê³„ì•½í•˜ê¸° ì¢‹ì€ ì‹œê¸°ì¼ê¹Œìš”? ì•„ë‹ˆë©´ ë” ê¸°ë‹¤ë ¤ì•¼ í• ê¹Œìš”?",
      "ì›”ì„¸ ìƒìŠ¹ì„¸ê°€ ì •ë§ ë¬´ì„œì›Œìš”... ğŸ’¸ ì‘ë…„ë³´ë‹¤ 20%ë‚˜ ì˜¬ëë‹¤ê³  í•˜ë„¤ìš”. ì´ê²Œ ì–¸ì œê¹Œì§€ ê°ˆê¹Œìš”? ì •ë§ ê±±ì •ì´ì—ìš”.",
      "ë¶€ë™ì‚° ì •ì±…ì´ ìì£¼ ë°”ë€Œì–´ì„œ í˜¼ë€ìŠ¤ëŸ¬ì›Œìš”... ğŸ˜µâ€ğŸ’« ì„ì°¨ì¸ ì…ì¥ì—ì„œ ì–´ë–¤ ì •ì±…ì´ ë„ì›€ì´ ë ê¹Œìš”? ì˜ê²¬ ë¶€íƒë“œë ¤ìš”!",
      "ìš”ì¦˜ ì „ì„¸ ì‚¬ê¸° ì‚¬ê±´ì´ ë„ˆë¬´ ë§ì•„ì„œ ë¬´ì„œì›Œìš”... ğŸ˜¨ ì–´ë–»ê²Œ í•˜ë©´ ì•ˆì „í•˜ê²Œ ì „ì„¸ë¥¼ êµ¬í•  ìˆ˜ ìˆì„ê¹Œìš”?"
    ],
    ë¶€ë™ì‚°ì‹œì¥: [
      "ë¶€ë™ì‚° ì¤‘ê°œë¹„ê°€ ì •ë§ ë¶€ë‹´ìŠ¤ëŸ¬ì›Œìš”... ğŸ˜¤ ë³´í†µ 0.5%ì¸ë° í° ëˆì´ì–ì•„ìš”. í˜¹ì‹œ ì ˆì•½í•  ìˆ˜ ìˆëŠ” ë°©ë²• ìˆë‚˜ìš”?",
      "ì•„íŒŒíŠ¸ vs ì˜¤í”¼ìŠ¤í…” ê³ ë¯¼ì´ ì‹¬í•´ìš”... ğŸ¤” ì•„íŒŒíŠ¸ëŠ” ê´€ë¦¬ë¹„ê°€ ë¹„ì‹¸ê³ , ì˜¤í”¼ìŠ¤í…”ì€ ì¢€ ë¶ˆì•ˆí•˜ê³ ... ê°ê°ì˜ ì¥ë‹¨ì ì´ ë­˜ê¹Œìš”?",
      "ì‹ ì¶• vs ë¦¬ëª¨ë¸ë§ ì¤‘ ì–´ë–¤ ê²Œ ë” ë‚˜ì„ê¹Œìš”? ğŸ˜• ì‹ ì¶•ì€ ë¹„ì‹¸ì§€ë§Œ ê¹¨ë—í•˜ê³ , ë¦¬ëª¨ë¸ë§ì€ ì €ë ´í•˜ì§€ë§Œ ë¶ˆì•ˆí•˜ê³ ... ê²½í—˜ë‹´ ê³µìœ  ë¶€íƒë“œë ¤ìš”!",
      "ë¶€ë™ì‚° ë§¤ë¬¼ ì •ë³´ëŠ” ì–´ë””ì„œ êµ¬í•˜ì‹œë‚˜ìš”? ğŸ  ë„¤ì´ë²„ë¶€ë™ì‚°, ì§ë°©, ë‹¤ë°© ë‹¤ ë´¤ëŠ”ë°... í˜¹ì‹œ ë” ì¢‹ì€ ì‚¬ì´íŠ¸ ìˆë‚˜ìš”?",
      "ê³„ì•½ ì „ì— ê¼­ í™•ì¸í•´ì•¼ í•  ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ìˆì„ê¹Œìš”? ğŸ“‹ ì‹¤ìˆ˜í•˜ë©´ ë‚˜ì¤‘ì— í›„íšŒí•  ê²ƒ ê°™ì•„ì„œ... ì¡°ì–¸ ë¶€íƒë“œë ¤ìš”!"
    ],
    ì„ëŒ€ì‹œì¥: [
      "ì›”ì„¸ í˜‘ìƒ ì„±ê³µí•˜ì‹  ë¶„ë“¤ ì •ë§ ë¶€ëŸ½ìŠµë‹ˆë‹¤... ğŸ˜ ì–´ë–»ê²Œ í•˜ì…¨ëŠ”ì§€ ê²½í—˜ë‹´ ë“¤ë ¤ì£¼ì„¸ìš”! ì €ë„ ì‹œë„í•´ë³´ê³  ì‹¶ì–´ìš”.",
      "ì„ëŒ€ì°¨ ê³„ì•½ì„œê°€ ë„ˆë¬´ ë³µì¡í•´ìš”... ğŸ“„ ì–´ë–¤ ë¶€ë¶„ì„ íŠ¹íˆ ì£¼ì˜í•´ì•¼ í• ê¹Œìš”? ê¼¼ê¼¼íˆ ì±™ê¸°ë¼ê³  í•˜ëŠ”ë° ì–´ë””ì„œë¶€í„° ì‹œì‘í•´ì•¼ í• ì§€ ëª¨ë¥´ê² ì–´ìš”.",
      "ë³´ì¦ê¸ˆ ë°˜í™˜ ë°›ì„ ë•Œ ë¬¸ì œ ì—†ìœ¼ì…¨ë‚˜ìš”? ğŸ˜° í˜¹ì‹œ ê¹ì´ê±°ë‚˜ ê±°ë¶€ë‹¹í•œ ê²½í—˜ ìˆìœ¼ì‹  ë¶„ ê³„ì‹ ê°€ìš”? íŒ ì•Œë ¤ì£¼ì„¸ìš”!",
      "ì›”ì„¸ ì¸ìƒ ì œí•œ ì¡°í•­ì´ ìˆë‹¤ê³  ë“¤ì—ˆëŠ”ë°... ğŸ¤·â€â™€ï¸ ì–´ë–»ê²Œ í™œìš©í•  ìˆ˜ ìˆë‚˜ìš”? ì§‘ì£¼ì¸ì´ ì›”ì„¸ ì˜¬ë¦°ë‹¤ê³  í•˜ëŠ”ë° ë§‰ì„ ìˆ˜ ìˆì„ê¹Œìš”?",
      "ì„ëŒ€ì¸ê³¼ ì†Œí†µí•  ë•Œ ì£¼ì˜í•  ì ì´ ìˆì„ê¹Œìš”? ğŸ˜… ë„ˆë¬´ ì¹œí•´ì§€ë©´ ì•ˆ ë˜ê³ , ë„ˆë¬´ ë”±ë”±í•˜ë©´ ì•ˆ ë˜ê³ ... ì ë‹¹í•œ ì„ ì´ ì–´ë””ì¸ì§€ ëª¨ë¥´ê² ì–´ìš”."
    ],
    ë¶„ìŸì‚¬ë¡€: [
      "ë³´ì¦ê¸ˆ ë°˜í™˜ ê±°ë¶€ ë‹¹í•œ ì  ìˆìœ¼ì‹  ë¶„ ê³„ì‹ ê°€ìš”? ğŸ˜¡ ì–´ë–»ê²Œ í•´ê²°í•˜ì…¨ëŠ”ì§€ ì •ë§ ê¶ê¸ˆí•´ìš”... ì €ë„ ë¹„ìŠ·í•œ ìƒí™©ì´ë¼ì„œ...",
      "ì›”ì„¸ ì¸ìƒ í†µë³´ ë°›ì•˜ì„ ë•Œ ì–´ë–»ê²Œ ëŒ€ì²˜í•˜ì…¨ë‚˜ìš”? ğŸ˜¤ ì •ë§ ê°‘ì‘ìŠ¤ëŸ¬ì›Œì„œ ë‹¹í™©í–ˆì–´ìš”... ê²½í—˜ë‹´ ë“¤ë ¤ì£¼ì„¸ìš”.",
      "ì‹œì„¤ ê³ ì¥ ì‹œ ì§‘ì£¼ì¸ê³¼ ì–´ë–»ê²Œ ì†Œí†µí•˜ì…¨ë‚˜ìš”? ğŸ”§ ì—ì–´ì»¨ì´ ê³ ì¥ë‚¬ëŠ”ë° ìˆ˜ë¦¬ë¹„ë¥¼ ëˆ„ê°€ ë‚´ì•¼ í• ì§€ ëª¨ë¥´ê² ì–´ìš”...",
      "ì…ì£¼ ê±°ë¶€ ë‹¹í•œ ê²½í—˜ ìˆìœ¼ì‹  ë¶„ ê³„ì‹ ê°€ìš”? ğŸšª ê³„ì•½ì„œì— ì„œëª…í–ˆëŠ”ë° ì§‘ì£¼ì¸ì´ ê°‘ìê¸° ë°”ê¿¨ë‹¤ê³  í•˜ë„¤ìš”... ì–´ë–»ê²Œ í•´ê²°í•˜ì…¨ë‚˜ìš”?",
      "ê³„ì•½ í•´ì§€ ê´€ë ¨ ë¶„ìŸ ê²½í—˜ ìˆìœ¼ì‹  ë¶„ë“¤ ì¡°ì–¸ ë¶€íƒë“œë ¤ìš”... ğŸ˜° ì§‘ì£¼ì¸ì´ ê°‘ìê¸° ë‚˜ê°€ë¼ê³  í•˜ë„¤ìš”."
    ],
    ë³´ì¦ê¸ˆ: [
      "ë³´ì¦ê¸ˆ ëŒ€ì¶œ ì´ìš©í•´ë³´ì‹  ë¶„ ê³„ì‹ ê°€ìš”? ğŸ’° ì–´ë–¤ ì¡°ê±´ì¸ì§€ ì •ë§ ê¶ê¸ˆí•´ìš”... ì´ììœ¨ì´ë‚˜ í•œë„ ê°™ì€ ê±°ìš”.",
      "ë³´ì¦ê¸ˆ ì ë¦½ê¸ˆ í™œìš©í•˜ëŠ” ë°©ë²• ìˆë‚˜ìš”? ğŸ’¡ ê·¸ëƒ¥ ë†”ë‘ëŠ” ê²ƒë³´ë‹¤ ë­”ê°€ í•  ìˆ˜ ìˆëŠ” ê²Œ ìˆì„ê¹Œìš”?",
      "ë³´ì¦ê¸ˆ ë°˜í™˜ ë°›ëŠ” íŒ ìˆìœ¼ì‹œë©´ ê³µìœ  ë¶€íƒë“œë ¤ìš”! ğŸ™ ì§‘ì£¼ì¸ì´ ê¹ìœ¼ë ¤ê³  í•˜ëŠ”ë° ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?",
      "ë³´ì¦ê¸ˆ ë°˜í™˜ ì‹œê¸°ëŠ” ì–¸ì œì¯¤ì¸ê°€ìš”? â° ê³„ì•½ ë§Œë£Œ í›„ ì–¼ë§ˆë‚˜ ê±¸ë¦¬ë‚˜ìš”? ê¶ê¸ˆí•´ìš”.",
      "ë³´ì¦ê¸ˆ ê´€ë ¨ ë²•ì  ê¶Œë¦¬ê°€ ìˆë‹¤ê³  ë“¤ì—ˆëŠ”ë°... âš–ï¸ ì–´ë–¤ ê²ƒë“¤ì´ ìˆë‚˜ìš”? ëª¨ë¥´ë©´ ì†í•´ ë³¼ ê²ƒ ê°™ì•„ì„œ..."
    ],
    ì›”ì„¸ì¸ìƒ: [
      "ì›”ì„¸ ì¸ìƒë¥ ì´ ì–´ëŠ ì •ë„ê°€ ì ì •í•˜ë‹¤ê³  ìƒê°í•˜ì‹œë‚˜ìš”? ğŸ“ˆ ì§‘ì£¼ì¸ì´ 10% ì˜¬ë¦°ë‹¤ê³  í•˜ëŠ”ë° ë„ˆë¬´ ë§ì€ ê±´ê°€ìš”?",
      "ì›”ì„¸ í˜‘ìƒ ì„±ê³µ ì‚¬ë¡€ ìˆìœ¼ì‹œë©´ ë“¤ë ¤ì£¼ì„¸ìš”! ğŸ’ª ì–´ë–»ê²Œ ë§ì”€í•˜ì…¨ëŠ”ì§€ ì •ë§ ê¶ê¸ˆí•´ìš”.",
      "ì›”ì„¸ ì¸ìƒ í†µë³´ ë°›ì•˜ì„ ë•Œ ëŒ€ì²˜ë²• ì•Œë ¤ì£¼ì„¸ìš”... ğŸ˜° ì •ë§ ë‹¹í™©ìŠ¤ëŸ¬ì›Œìš”.",
      "ì›”ì„¸ vs ì „ì„¸ ì „í™˜ì„ ê³ ë ¤ ì¤‘ì¸ë° ì–´ë–»ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”? ğŸ¤” ì›”ì„¸ê°€ ê³„ì† ì˜¤ë¥´ë‹ˆê¹Œ ì „ì„¸ê°€ ë‚˜ì„ê¹Œìš”?",
      "ì›”ì„¸ ì¸ìƒ ì œí•œ ì¡°í•­ì„ ì–´ë–»ê²Œ í™œìš©í•  ìˆ˜ ìˆë‚˜ìš”? ğŸ“‹ ì„ëŒ€ì°¨ 3ë²•ì´ ìˆë‹¤ê³  ë“¤ì—ˆëŠ”ë°..."
    ],
    ê³„ì•½í•´ì§€: [
      "ì„ëŒ€ì°¨ ê³„ì•½ í•´ì§€ ì ˆì°¨ê°€ ë³µì¡í•œê°€ìš”? ğŸ“ ê²½í—˜ë‹´ ë“¤ë ¤ì£¼ì„¸ìš”... ì´ì‚¬ ì¤€ë¹„ë„ í•´ì•¼ í•˜ê³  ì •ë§ ë³µì¡í•  ê²ƒ ê°™ì•„ìš”.",
      "ê³„ì•½ í•´ì§€ ì‹œ ì£¼ì˜ì‚¬í•­ì´ ë­”ì§€ ê¶ê¸ˆí•´ìš”... âš ï¸ ì‹¤ìˆ˜í•˜ë©´ ì†í•´ ë³¼ ê²ƒ ê°™ì•„ì„œ ë¯¸ë¦¬ ì•Œê³  ì‹¶ì–´ìš”.",
      "ê°‘ì‘ìŠ¤ëŸ¬ìš´ ê³„ì•½ í•´ì§€ ë‹¹í–ˆì„ ë•Œ ì–´ë–»ê²Œ ëŒ€ì²˜í•´ì•¼ í• ê¹Œìš”? ğŸ˜± ì§‘ì£¼ì¸ì´ ê°‘ìê¸° ë‚˜ê°€ë¼ê³  í•˜ë„¤ìš”...",
      "ê³„ì•½ í•´ì§€ í›„ ì´ì‚¬ ì¤€ë¹„ëŠ” ì–´ë–»ê²Œ í•˜ì‹œë‚˜ìš”? ğŸ“¦ ì´ì‚¬ë¹„ë„ ë¹„ì‹¸ê³ ... ì ˆì•½í•  ìˆ˜ ìˆëŠ” ë°©ë²• ìˆë‚˜ìš”?",
      "ê³„ì•½ í•´ì§€ ê´€ë ¨ ë²•ì  ë¬¸ì œê°€ ìˆì„ ìˆ˜ ìˆë‚˜ìš”? âš–ï¸ ì§‘ì£¼ì¸ê³¼ ë§ˆì°°ì´ ìƒê²¼ëŠ”ë°..."
    ]
  };

  const contents = diverseContents[category] || ["ì•ˆë…•í•˜ì„¸ìš”! ê´€ë ¨í•´ì„œ ê¶ê¸ˆí•œ ì ì´ ìˆì–´ì„œ ì§ˆë¬¸ë“œë ¤ìš”."];
  const randomContent = contents[Math.floor(Math.random() * contents.length)];
  
  return randomContent;
}

// AI ê¸°ë°˜ ê²Œì‹œê¸€ ìƒì„±
async function createPostWithAI(postData) {
  try {
    const response = await fetch(`${process.env.SITE_BASE_URL || 'https://homeless-town.onrender.com'}/api/discussions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        title: postData.title,
        content: postData.content,
        tags: postData.tags || ['ì‹œí™©'],
        nickname: diverseAuthors[Math.floor(Math.random() * diverseAuthors.length)],
        password: 'ai123',
        marketTrend: Math.random() > 0.5 ? 'up' : 'down'
      }),
    });
    
    if (response.ok) {
      const result = await response.json();
      console.log(`âœ… AI ê²Œì‹œê¸€ ìƒì„± ì„±ê³µ: ${postData.title}`);
      return result.id || true;
    } else {
      const errorText = await response.text();
      console.log(`âŒ AI ê²Œì‹œê¸€ ìƒì„± ì‹¤íŒ¨: ${postData.title} - ${errorText}`);
      return false;
    }
  } catch (error) {
    console.log(`âŒ AI ê²Œì‹œê¸€ ìƒì„± ì˜¤ë¥˜: ${postData.title} - ${error.message}`);
    return false;
  }
}

// AI ê¸°ë°˜ ëŒ“ê¸€ ìƒì„±
async function createAIComments(postId, postTitle, postContent) {
  try {
    const comments = await generateAIComment(postContent, postTitle, 3);
    
    for (const commentContent of comments) {
      await fetch(`${process.env.SITE_BASE_URL || 'https://homeless-town.onrender.com'}/api/discussions/${postId}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          content: commentContent,
          nickname: diverseAuthors[Math.floor(Math.random() * diverseAuthors.length)],
          password: 'ai123'
        }),
      });
      
      // ëŒ“ê¸€ ê°„ ê°„ê²©
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    console.log(`ğŸ’¬ AI ëŒ“ê¸€ ${comments.length}ê°œ ìƒì„± ì™„ë£Œ`);
  } catch (error) {
    console.log(`âŒ AI ëŒ“ê¸€ ìƒì„± ì˜¤ë¥˜: ${error.message}`);
  }
}

// AIë¡œ í…œí”Œë¦¿ ê¸°ë°˜ ê¸€ì„ êµ¬ì²´ì ì´ê³  í˜„ì‹¤ì ìœ¼ë¡œ í–¥ìƒ
async function generateAIEnhancedPost(template, category) {
  try {
    const prompt = `
ë‹¤ìŒ ì£¼ì œë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¬´ì£¼íƒì´Œ ì»¤ë®¤ë‹ˆí‹° í† ë¡ ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”:

ì£¼ì œ: ${template}
ì¹´í…Œê³ ë¦¬: ${category}

ìš”êµ¬ì‚¬í•­:
1. ì œëª©ì€ 30ì ì´ë‚´ë¡œ ì‘ì„±
2. ë‚´ìš©ì€ 300-500ì ì •ë„ë¡œ ì‘ì„±
3. ì‹¤ì œ ë¬´ì£¼íƒì/ì „ì„¸ì/ì›”ì„¸ìì˜ ê´€ì ì—ì„œ ì‘ì„±
4. êµ¬ì²´ì ì¸ ìˆ˜ì¹˜, ì§€ì—­, ê¸ˆì•¡, ì •ì±…ëª…ì„ í¬í•¨
5. ì‹¤ì œ ê²½í—˜ì´ë‚˜ ìƒí™©ì„ êµ¬ì²´ì ìœ¼ë¡œ ë¬˜ì‚¬
6. ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì´ ëŒ“ê¸€ì„ ë‹¬ê³  ì‹¶ì–´í•  ë§Œí•œ êµ¬ì²´ì ì¸ ì§ˆë¬¸ì´ë‚˜ ì˜ê²¬ ìš”ì²­ í¬í•¨
7. ì¹œê·¼í•˜ì§€ë§Œ í˜„ì‹¤ì ì¸ í†¤ìœ¼ë¡œ ì‘ì„±
8. í•œêµ­ì–´ë¡œ ì‘ì„±
9. ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
10. ìì—°ìŠ¤ëŸ½ê³  ì‹¤ì œ ì‚¬ìš©ìê°€ ì“´ ê²ƒì²˜ëŸ¼ ì‘ì„±
11. "ì–´ë–»ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”?" ê°™ì€ ì¼ë°˜ì ì¸ ì§ˆë¬¸ë³´ë‹¤ëŠ” êµ¬ì²´ì ì¸ ìƒí™©ì— ëŒ€í•œ ì˜ê²¬ì„ ìš”ì²­
12. ìµœì‹  ë¶€ë™ì‚° ì‹œì¥ ë™í–¥ì´ë‚˜ ì •ì±… ë³€í™”ë¥¼ ë°˜ì˜

ì‘ë‹µ í˜•ì‹:
ì œëª©: [ì œëª©]
ë‚´ìš©: [ë‚´ìš©]
íƒœê·¸: [íƒœê·¸1,íƒœê·¸2]
`;

    const completion = await openai.chat.completions.create({
      model: "gpt-3.5-turbo",
      messages: [{ role: "user", content: prompt }],
      max_tokens: 800,
      temperature: 0.7,
    });

    const response = completion.choices[0]?.message?.content || '';
    
    // ì‘ë‹µ íŒŒì‹±
    const titleMatch = response.match(/ì œëª©:\s*(.+)/);
    const contentMatch = response.match(/ë‚´ìš©:\s*([\s\S]+?)(?=íƒœê·¸:|$)/);
    const tagsMatch = response.match(/íƒœê·¸:\s*(.+)/);
    
    const title = titleMatch?.[1]?.trim() || template;
    const content = contentMatch?.[1]?.trim() || '';
    const tags = tagsMatch?.[1]?.split(',').map(t => t.trim()) || getTagsForCategory(category);

    return { title, content, tags };
  } catch (error) {
    console.log('AI í…œí”Œë¦¿ í–¥ìƒ ì˜¤ë¥˜:', error.message);
    return {
      title: template,
      content: `${template}ì— ëŒ€í•´ ì–´ë–»ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”? ì‹¤ì œ ê²½í—˜ë‹´ì´ë‚˜ ì¡°ì–¸ì´ ìˆìœ¼ì‹œë©´ ëŒ“ê¸€ë¡œ ê³µìœ í•´ì£¼ì„¸ìš”!`,
      tags: getTagsForCategory(category)
    };
  }
}

// ì˜¤ëŠ˜ ìë™ ê¸€ ë“±ë¡
async function enqueueToday() {
  if (!postQueue) {
    console.log('âš ï¸ Redisê°€ ì—°ê²°ë˜ì§€ ì•Šì•„ ì¦‰ì‹œ ì‹¤í–‰ ëª¨ë“œë¡œ ì „í™˜');
    
    console.log('ğŸš€ ê°œì„ ëœ ìë™ í¬ìŠ¤íŒ… ì‹œì‘ (ë‰´ìŠ¤ ê¸°ë°˜ + AI ìƒì„±)...');
    
    // ë‰´ìŠ¤ ê¸°ë°˜ í¬ìŠ¤íŒ… ë¨¼ì € ì‹œë„
    let newsBasedPosts = 0;
    try {
      console.log('ğŸ“° ìµœì‹  ë¶€ë™ì‚° ë‰´ìŠ¤ ê°€ì ¸ì˜¤ëŠ” ì¤‘...');
      const newsItems = await fetchRealEstateNews();
      
      if (newsItems.length > 0) {
        console.log(`ğŸ“° ${newsItems.length}ê°œì˜ ë¶€ë™ì‚° ë‰´ìŠ¤ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
        
        // ìµœì‹  ë‰´ìŠ¤ 3ê°œë¡œ í† ë¡ ê¸€ ìƒì„±
        const selectedNews = newsItems.slice(0, 3);
        
        for (const newsItem of selectedNews) {
          const newsPost = await generateNewsBasedPost(newsItem);
          console.log(`ğŸ“° ë‰´ìŠ¤ ê¸°ë°˜ í† ë¡ ê¸€ ìƒì„±: ${newsPost.title}`);
          
          const success = await createPostWithAI(newsPost);
          if (success) {
            newsBasedPosts++;
            console.log(`âœ… ë‰´ìŠ¤ ê¸°ë°˜ í¬ìŠ¤íŒ… ì„±ê³µ: ${newsPost.title}`);
            
            // AI ëŒ“ê¸€ë„ ìƒì„±
            await createAIComments(success, newsPost.title, newsPost.content);
          } else {
            console.log(`âŒ ë‰´ìŠ¤ ê¸°ë°˜ í¬ìŠ¤íŒ… ì‹¤íŒ¨: ${newsPost.title}`);
          }
          
          // í¬ìŠ¤íŒ… ê°„ ê°„ê²©
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      } else {
        console.log('ğŸ“° ë¶€ë™ì‚° ë‰´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¼ë°˜ í¬ìŠ¤íŒ…ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
      }
    } catch (error) {
      console.log('ğŸ“° ë‰´ìŠ¤ API ì˜¤ë¥˜:', error.message);
      console.log('ğŸ“° ì¼ë°˜ í¬ìŠ¤íŒ…ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
    }
    
    // ê¸°ì¡´ í…œí”Œë¦¿ ê¸°ë°˜ í¬ìŠ¤íŒ… (ë‰´ìŠ¤ ê¸°ë°˜ì´ ë¶€ì¡±í•  ê²½ìš°)
    const categories = Object.keys(discussionTemplates);
    const remainingPosts = Math.max(0, 5 - newsBasedPosts); // ì´ 5ê°œ ëª©í‘œ
    
    console.log(`ğŸ“ í…œí”Œë¦¿ ê¸°ë°˜ í¬ìŠ¤íŒ… ${remainingPosts}ê°œ ì¶”ê°€ ìƒì„±`);

    for (let i = 0; i < remainingPosts; i++) {
      const category = categories[Math.floor(Math.random() * categories.length)];
      const templates = discussionTemplates[category];
      
      // í…œí”Œë¦¿ì—ì„œ ëœë¤í•˜ê²Œ ì„ íƒ
      const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
      
      // AIë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ê¸€ ìƒì„±
      const aiPost = await generateAIEnhancedPost(randomTemplate, category);
      
      console.log(`ğŸ¤– AI í–¥ìƒëœ í…œí”Œë¦¿ ê¸°ë°˜ ê¸€ ìƒì„±: ${aiPost.title}`);
      
      const success = await createPostWithAI(aiPost);
      if (success) {
        console.log(`âœ… AI í…œí”Œë¦¿ ê¸°ë°˜ í¬ìŠ¤íŒ… ì„±ê³µ: ${aiPost.title}`);
        
        // AI ëŒ“ê¸€ë„ ìƒì„±
        await createAIComments(success, aiPost.title, aiPost.content);
      } else {
        console.log(`âŒ AI í…œí”Œë¦¿ ê¸°ë°˜ í¬ìŠ¤íŒ… ì‹¤íŒ¨: ${aiPost.title}`);
      }
      
      // í¬ìŠ¤íŒ… ê°„ ê°„ê²©
      await new Promise(resolve => setTimeout(resolve, 2000));
    }
    
    console.log(`ğŸ‰ ìë™ í¬ìŠ¤íŒ… ì™„ë£Œ! ë‰´ìŠ¤ ê¸°ë°˜: ${newsBasedPosts}ê°œ, í…œí”Œë¦¿ ê¸°ë°˜: ${remainingPosts}ê°œ`);
    
    return;
  }
  
  // Redisê°€ ìˆëŠ” ê²½ìš°ì˜ ê¸°ì¡´ ë¡œì§ (ê°„ì†Œí™”)
  try {
    console.log('ğŸ“ Redis íì— ì‘ì—… ì¶”ê°€ ì¤‘...');
          
          const res = await fetch(`${process.env.SITE_BASE_URL}/api/admin/posts`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${process.env.ADMIN_TOKEN}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              title,
              content,
              categorySlug: category,
              status: 'published',
              tags: getTagsForCategory(category), // ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” íƒœê·¸ë“¤ ì‚¬ìš©
              author: diverseAuthors[Math.floor(Math.random() * diverseAuthors.length)],
            }),
          });

          const responseText = await res.text();
          console.log(`ğŸ“Š ì‘ë‹µ ìƒíƒœ: ${res.status}`);
          console.log(`ğŸ“„ ì‘ë‹µ ë‚´ìš©: ${responseText}`);

          if (res.ok) {
            console.log(`âœ… ê²Œì‹œê¸€ ìƒì„± ì„±ê³µ: ${title}`);
            
            // ê²Œì‹œê¸€ ìƒì„± ì„±ê³µ ì‹œ ëŒ“ê¸€ ì¶”ê°€
            try {
              const postData = JSON.parse(responseText);
              const postId = postData.post?.id;
              
              if (postId) {
                // 2~5ê°œì˜ ëœë¤ ëŒ“ê¸€ ìˆ˜ ê²°ì •
                const commentCount = Math.floor(Math.random() * 4) + 2; // 2~5
                console.log(`ğŸ’¬ ëŒ“ê¸€ ${commentCount}ê°œ ìƒì„± ì¤‘...`);
                
                // ëŒ“ê¸€ ìƒì„± (ê²Œì‹œê¸€ ë§íˆ¬ ì •ë³´ ì „ë‹¬)
                const comments = await generateComments(content, postType, category, commentCount, usePolite);
                
                // ê° ëŒ“ê¸€ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‘ì„±
                for (const commentContent of comments) {
                  const commentAuthor = diverseAuthors[Math.floor(Math.random() * diverseAuthors.length)];
                  
                  try {
                    const commentRes = await fetch(`${process.env.SITE_BASE_URL}/api/posts/${postId}/comments`, {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                      body: JSON.stringify({
                        content: commentContent,
                        author: commentAuthor,
                        nickname: commentAuthor,
                      }),
                    });
                    
                    if (commentRes.ok) {
                      console.log(`âœ… ëŒ“ê¸€ ì‘ì„± ì„±ê³µ: ${commentContent.substring(0, 30)}...`);
                    } else {
                      console.log(`âŒ ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨: ${commentRes.status}`);
                    }
                    
                    // ëŒ“ê¸€ ì‘ì„± ê°„ê²© (0.5ì´ˆ)
                    await new Promise((r) => setTimeout(r, 500));
                  } catch (commentError) {
                    console.error(`ëŒ“ê¸€ ì‘ì„± ì˜¤ë¥˜:`, commentError.message);
                  }
                }
              }
            } catch (commentError) {
              console.error(`ëŒ“ê¸€ ìƒì„± ê³¼ì • ì˜¤ë¥˜:`, commentError.message);
            }
          } else {
            console.log(`âŒ ê²Œì‹œê¸€ ìƒì„± ì‹¤íŒ¨: ${title} - ${res.status}`);
            console.log(`âŒ ì˜¤ë¥˜ ìƒì„¸: ${responseText}`);
            
            // 500 ì˜¤ë¥˜ì¸ ê²½ìš° ìƒì„¸ ì •ë³´ ì¶œë ¥
            if (res.status === 500) {
              console.log(`ğŸš¨ 500 ì˜¤ë¥˜ ê°ì§€! API ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì˜¤ë¥˜ ë°œìƒ.`);
              console.log(`ğŸ” ë©”ì¸ ì•± URL: ${process.env.SITE_BASE_URL}`);
              
              try {
                // ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±í•˜ì—¬ ìƒì„¸ ì˜¤ë¥˜ ì •ë³´ í™•ì¸
                let errorDetails = responseText;
                try {
                  const errorJson = JSON.parse(responseText);
                  errorDetails = JSON.stringify(errorJson, null, 2);
                } catch (parseError) {
                  // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ ì‚¬ìš©
                }
                console.log(`ğŸ” API ì˜¤ë¥˜ ìƒì„¸: ${errorDetails}`);
              } catch (error) {
                console.log(`ğŸ” ì˜¤ë¥˜ ìƒì„¸ íŒŒì‹± ì‹¤íŒ¨: ${error.message}`);
              }
            }
            
            // 502 ì˜¤ë¥˜ì¸ ê²½ìš° ë©”ì¸ ì•± ìƒíƒœ í™•ì¸
            if (res.status === 502) {
              console.log(`ğŸš¨ 502 ì˜¤ë¥˜ ê°ì§€! ë©”ì¸ ì•± ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
              console.log(`ğŸ” ë©”ì¸ ì•± URL: ${process.env.SITE_BASE_URL}`);
              console.log(`ğŸ” ë©”ì¸ ì•± í—¬ìŠ¤ì²´í¬ ì‹œë„...`);
              
              try {
                const healthCheck = await fetch(`${process.env.SITE_BASE_URL}/api/debug-db`);
                console.log(`ğŸ” í—¬ìŠ¤ì²´í¬ ìƒíƒœ: ${healthCheck.status}`);
              } catch (healthError) {
                console.log(`ğŸ” í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: ${healthError.message}`);
              }
            }
          }
        } catch (error) {
          console.log(`âŒ ê²Œì‹œê¸€ ìƒì„± ì˜¤ë¥˜: ${title}`, error.message);
        }
        
        await new Promise((r) => setTimeout(r, 5000)); // 5ì´ˆ ê°„ê²© (OpenAI API í˜¸ì¶œ ì‹œê°„ ê³ ë ¤)
      }
    }
    
    console.log('ğŸ‰ ì¦‰ì‹œ ì‹¤í–‰ ì™„ë£Œ!');
    return;
  }

  // Redisê°€ ìˆì„ ë•Œì˜ ê¸°ì¡´ ë¡œì§
  const categories = Object.keys(discussionTemplates);
  const TARGET_PER_CAT = Math.floor(160 / categories.length);

  console.log(`ğŸš€ ${categories.length}ê°œ ì¹´í…Œê³ ë¦¬ì— ì´ ${TARGET_PER_CAT * categories.length}ê°œ ê²Œì‹œê¸€ ë“±ë¡ ì‹œì‘`);

  for (const category of categories) {
    const templates = discussionTemplates[category];
    
    for (let i = 0; i < TARGET_PER_CAT; i++) {
      let title;
      
      // ëª¨ë“  í…œí”Œë¦¿ì„ ëœë¤í•˜ê²Œ ì„ì–´ì„œ ì‚¬ìš©
      const shuffledTemplates = [...templates].sort(() => Math.random() - 0.5);
      const baseTemplate = shuffledTemplates[i % shuffledTemplates.length];
      
      // ì œëª©ì— ëœë¤ ìš”ì†Œ ì¶”ê°€í•˜ì—¬ ì¤‘ë³µ ë°©ì§€
      const randomSuffixes = [
        '', ' ì •ë§ ê³ ë¯¼ì´ì—ìš”', ' ë„ì›€ ë¶€íƒë“œë ¤ìš”', ' ì¡°ì–¸ êµ¬í•´ìš”', 
        ' ê²½í—˜ë‹´ ê³µìœ í•´ìš”', ' ê¶ê¸ˆí•´ìš”', ' ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?',
        ' íŒ ìˆë‚˜ìš”?', ' ì •ë³´ ë¶€íƒë“œë ¤ìš”', ' ì˜ê²¬ ê¶ê¸ˆí•´ìš”',
        ' ê³ ë¯¼ì´ì—ìš”', ' ë§‰ë§‰í•´ìš”', ' í˜ë“¤ì–´ìš”', ' ì–´ë ¤ì›Œìš”'
      ];
      
      const randomSuffix = randomSuffixes[Math.floor(Math.random() * randomSuffixes.length)];
      title = `[${category}] ${baseTemplate}${randomSuffix}`;

      const content = await generateRealisticContent(category, title);
      
      const totalPosts = TARGET_PER_CAT * categories.length;
      const delayMs = Math.floor((i * categories.length + categories.indexOf(category)) * (24 * 60 * 60 * 1000) / totalPosts);

      await postQueue.add(
        'post',
        { title, content, categorySlug: category },
        {
          attempts: 3,
          backoff: { type: 'exponential', delay: 30_000 },
          delay: delayMs,
          removeOnComplete: true,
          removeOnFail: false,
        }
      );
    }
    
    console.log(`âœ… ${category} ì¹´í…Œê³ ë¦¬ ${TARGET_PER_CAT}ê°œ ê¸€ ë“±ë¡ ì™„ë£Œ`);
  }

  console.log('ğŸ‰ ì˜¤ëŠ˜ ì‘ì—… ë“±ë¡ ì™„ë£Œ!');
}

module.exports = { enqueueToday };
